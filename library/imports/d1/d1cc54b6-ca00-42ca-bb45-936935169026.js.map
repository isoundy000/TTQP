{"version":3,"sources":["../../../../../assets/Script/socket/assets/Script/socket/websocketScript.js"],"names":["window","onfire","require","errCodeObj","websocketAPIObj","host","jajale","WS","socket","connect","state","readyState","console","log","WebSocket","binaryType","onopen","openFire","bind","onclose","closeFire","onmessage","messageFire","onerror","errorFire","fire","obj","a","Uint8Array","data","dv","DataView","msgLen","getInt16","cmdId","getInt32","retCode","codeType","info","byteToString","slice","length","JSON","parse","err_code","err_msg","e","send","parm","stringify","byteArr","ArrayBuffer","setUint16","setUint32","OPEN","tmp","stringToByte","l","i","setUint8","str","bytes","Array","len","c","charCodeAt","push","bytearr","_arr","one","toString","v","match","bytesLength","store","st","String","fromCharCode","parseInt","module","exports"],"mappings":"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","file":"websocketScript.js","sourceRoot":"../../../../../assets/Script/socket","sourcesContent":["\nwindow.onfire = require(\"onfire\");\nvar errCodeObj = require(\"errCode\");\nvar websocketAPIObj = require(\"websocket_API\");\n\nwindow.host = \"ws://192.168.3.84:8072\";\nwindow.jajale = \"ws://192.168.3.84:8073\";\n\nvar WS = {\n\n    socket: {},\n\n    connect: function(state) {\n\n        this.state = state;\n\n        if (this.socket.readyState !== 1) {\n            // 这里还有内存泄漏的bug，未解决！！！\n            if (state == 'home') {\n                console.log(host);\n                this.socket = new WebSocket(host);\n                this.socket.binaryType = \"arraybuffer\";\n                this.socket.onopen = this.openFire.bind(this);\n                this.socket.onclose = this.closeFire.bind(this);\n                this.socket.onmessage = this.messageFire.bind(this);\n                this.socket.onerror = this.errorFire.bind(this);\n            }else if (state == 'jajale') {\n                console.log(jajale);\n                this.socket = new WebSocket(jajale);\n                this.socket.binaryType = \"arraybuffer\";\n                this.socket.onopen = this.openFire.bind(this);\n                this.socket.onclose = this.closeFire.bind(this);\n                this.socket.onmessage = this.messageFire.bind(this);\n                this.socket.onerror = this.errorFire.bind(this);\n            }\n            \n        }\n\n        return this;\n    },\n\n    \n    openFire: function() {\n\n        console.log('open',this.state);\n        onfire.fire('socketOpen',this.state);\n    },\n    /**\n     * 触发接收监听 \n     */\n    messageFire: function(obj) {\n\n        // 接收 socket 请求 需要拆包（二进制）\n        // 请求头为 12 个字节\n        // 第一、二个字节为消息长度、第三、四、五、六个字节为接口命令、第七、八、九、十个字节为保留字、第十一、十二个字节为服务器字段（不管）、后面追加消息体（传参）\n        \n        // console.log(obj);\n        var a = new Uint8Array(obj.data);\n        var dv = new DataView(obj.data);\n        var msgLen = dv.getInt16(0, false);\n        var cmdId = dv.getInt32(2, false);\n        var retCode = dv.getInt32(6, false);\n        var codeType = dv.getInt16(10, false);\n\n        var info = this.byteToString(a.slice(12));;  \n        console.log(msgLen,cmdId,retCode,codeType,info);\n        if (cmdId === 9000) {\n            console.log('响应9000协议ID');\n        }\n        if (retCode == 10000 || retCode == 110000 ) {\n            \n            // 事件触发\n            if (info.length > 0 && info != 'null') {\n                onfire.fire(websocketAPIObj[cmdId],JSON.parse(info));\n            }else {\n                onfire.fire(websocketAPIObj[cmdId]);\n            }\n            \n        } else {\n            // 错误\n            console.log(errCodeObj[retCode]);\n            if (retCode === 10205) {    \n                // 处理添加好友申请的时候，需要在邮件已经处理的状态下，将回调返回去\n                onfire.fire(websocketAPIObj[cmdId],{\n                    err_code: retCode,\n                    err_msg: errCodeObj[retCode]\n                });\n            }\n\n            if (cmdId == 10802) {\n                // 处理添加好友申请的时候，需要在邮件已经处理的状态下，将回调返回去\n                onfire.fire(websocketAPIObj[cmdId],{\n                    err_code: retCode\n                });\n            }\n        }\n    },\n\n    closeFire: function() {\n\n        console.log('close321');\n    },\n\n    errorFire: function(e) {\n        console.log(e);\n    },\n    /**\n     * 触发发送\n     * cmdId: 命令ID、parm: 参数（JSON）\n     */\n    send: function(cmdId, parm) {\n\n        // 发送 socket 请求 需要封包（二进制）\n        // 消息头为 8 个字节\n       \n        // 第一、二个字节为消息长度、第三、四、五、六个字节为接口命令、第七、八个字节为保留字、后面追加消息体（传参）\n        console.log(\"接口ID == \" + cmdId + \"，参数 == \" + JSON.stringify(parm));\n        if (typeof parm === 'undefined') {\n            // 无参\n            var byteArr = new ArrayBuffer(8);\n            var dv = new DataView(byteArr);\n            dv.setUint16(0,8,false);\n            dv.setUint32(2,cmdId,false);\n            dv.setUint16(6,1,false);\n            if (this.socket.readyState === WebSocket.OPEN){\n                this.socket.send(dv);\n            }\n            \n        } else {\n            var tmp;\n            if (typeof parm === 'string') {\n                tmp = this.stringToByte(parm);\n            }else {\n                tmp = this.stringToByte(JSON.stringify(parm));\n            }\n            // var tmp = this.stringToByte(JSON.stringify(parm));\n            var l = 8 + tmp.length;\n            var byteArr = new ArrayBuffer(l);\n            var dv = new DataView(byteArr);\n            dv.setUint16(0,l,false);\n            dv.setUint32(2,cmdId,false);\n            dv.setUint16(6,1,false);\n            for (var i = 0; i < tmp.length; i++) {\n                dv.setUint8(i + 8, tmp[i]);\n            }\n            if (this.socket.readyState === WebSocket.OPEN){\n                this.socket.send(dv);\n            }\n        }\n        \n        if (cmdId === 110101) {\n            console.log(this.socket);\n        }\n        // 这里这样操作的话无法对中文正确封包\n        // for (let idx = 0; idx < tmp.length; idx++) {\n        //     dv.setUint8(idx+6,tmp[idx].charCodeAt());\n        // }        \n        \n        \n    },\n\n    /**\n     * stringToByte()\n     * byteToString()\n     * 这两个函数是处理二进制封包、解包时中文乱码的问题\n     */\n    //string转byte数组\n    stringToByte: function(str){\n        var bytes = new Array();  \n        var len, c;  \n        len = str.length;  \n        for(var i = 0; i < len; i++) {  \n            c = str.charCodeAt(i);  \n            if(c >= 0x010000 && c <= 0x10FFFF) {  \n                bytes.push(((c >> 18) & 0x07) | 0xF0);  \n                bytes.push(((c >> 12) & 0x3F) | 0x80);  \n                bytes.push(((c >> 6) & 0x3F) | 0x80);  \n                bytes.push((c & 0x3F) | 0x80);  \n            } else if(c >= 0x000800 && c <= 0x00FFFF) {  \n                bytes.push(((c >> 12) & 0x0F) | 0xE0);  \n                bytes.push(((c >> 6) & 0x3F) | 0x80);  \n                bytes.push((c & 0x3F) | 0x80);  \n            } else if(c >= 0x000080 && c <= 0x0007FF) {  \n                bytes.push(((c >> 6) & 0x1F) | 0xC0);  \n                bytes.push((c & 0x3F) | 0x80);  \n            } else {  \n                bytes.push(c & 0xFF);  \n            }  \n        }  \n        return bytes;  \n    },\n    // byte数组转string\n     byteToString: function(bytearr) {\n        if (typeof bytearr === 'string') {\n            return bytearr;\n        }\n        var str = '',\n        _arr = bytearr;\n        for (var i = 0; i < _arr.length; i++) {\n            var one = _arr[i].toString(2),\n            v = one.match(/^1+?(?=0)/);\n        if (v && one.length == 8) {\n            var bytesLength = v[0].length;\n            var store = _arr[i].toString(2).slice(7 - bytesLength);\n            for (var st = 1; st < bytesLength; st++) {\n                store += _arr[st + i].toString(2).slice(2);\n            }\n            str += String.fromCharCode(parseInt(store, 2));\n            i += bytesLength - 1;\n        } else {\n            str += String.fromCharCode(_arr[i]);\n        }\n        }\n        return str;\n  }\n\n}\n\nmodule.exports = WS;\n"]}